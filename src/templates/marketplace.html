<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            padding: 40px 0;
        }
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.2rem 0;
            margin-bottom: 40px;
        }
        .navbar-brand {
            font-size: 1.4rem;
            font-weight: 600;
            color: #f8fafc;
        }
        h1 {
            color: #f8fafc;
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 40px;
        }
        .filters {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 40px;
        }
        .form-label {
            color: #cbd5e1;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .form-select, .form-control {
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e7;
            border-radius: 8px;
            padding: 10px 14px;
        }
        .form-select:focus, .form-control:focus {
            background: #0f172a;
            border-color: #3b82f6;
            color: #e4e4e7;
            box-shadow: none;
        }
        .btn-primary {
            background: #3b82f6;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .apartment-card {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            height: 100%;
        }
        .apartment-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-4px);
        }
        .apartment-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            cursor: pointer;
        }
        .apartment-details {
            padding: 20px;
        }
        .apartment-details h5 {
            color: #f8fafc;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .text-muted {
            color: #94a3b8 !important;
            font-size: 0.875rem;
        }
        .price-tag {
            font-size: 1.75rem;
            font-weight: 700;
            color: #3b82f6;
            margin: 12px 0;
        }
        .roi-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        .roi-good {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .roi-medium {
            background: rgba(234, 179, 8, 0.1);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        .roi-bad {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .btn-outline-primary {
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
            background: transparent;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-outline-primary:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .pagination-controls {
            text-align: center;
            margin: 40px 0;
        }
        .pagination-controls button {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            padding: 12px 28px;
            border-radius: 8px;
            margin: 0 10px;
            font-weight: 500;
        }
        .pagination-controls button:hover:not(:disabled) {
            background: #334155;
            border-color: #3b82f6;
        }
        .pagination-controls button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        #pageInfo {
            color: #cbd5e1;
            font-weight: 600;
            margin: 0 20px;
        }
        #loading {
            text-align: center;
            padding: 60px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-color: #3b82f6;
            border-right-color: transparent;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }
        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            max-width: 1100px;
            width: 100%;
            position: relative;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #cbd5e1;
            font-size: 2rem;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            z-index: 10;
            font-weight: 300;
            line-height: 1;
        }
        .modal-close:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .modal-gallery {
            position: relative;
            width: 100%;
            height: 500px;
            background: #0f172a;
            border-radius: 16px 16px 0 0;
        }
        .modal-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px 16px 0 0;
        }
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.5rem;
            color: #cbd5e1;
            font-weight: 300;
        }
        .gallery-nav:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .gallery-nav.prev { left: 20px; }
        .gallery-nav.next { right: 20px; }
        .gallery-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: #cbd5e1;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-details {
            padding: 40px;
        }
        .modal-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 12px;
        }
        .modal-title {
            font-size: 1.5rem;
            color: #f8fafc;
            margin-bottom: 24px;
            font-weight: 600;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .detail-item {
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 10px;
        }
        .detail-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .detail-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #f8fafc;
        }
        .modal-map {
            width: 100%;
            height: 320px;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }
        .form-control::placeholder {
            color: #64748b;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <span class="navbar-brand">Investment Marketplace</span>
        </div>
    </nav>

    <div class="container">
        <h1>Apartments for Sale</h1>
        
        <div class="filters">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">District</label>
                    <select id="filterDistrict" class="form-select">
                        <option value="">All Districts</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Disposition</label>
                    <select id="filterDisposition" class="form-select">
                        <option value="">All Dispositions</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Price (CZK)</label>
                    <input type="number" id="filterMinPrice" class="form-control" placeholder="3000000" step="100000">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max Price (CZK)</label>
                    <input type="number" id="filterMaxPrice" class="form-control" placeholder="10000000" step="100000">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button onclick="applyFilters()" class="btn btn-primary w-100">Apply</button>
                </div>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner-border" role="status"></div>
            <p style="color: #94a3b8; margin-top: 20px;">Loading listings...</p>
        </div>
        
        <div id="apartmentsList" class="row" style="display:none;"></div>
        
        <div class="pagination-controls">
            <button id="prevBtn" onclick="prevPage()" disabled>‚Üê Previous</button>
            <span id="pageInfo"></span>
            <button id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
        </div>
    </div>

    <div id="apartmentModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            
            <div id="modalGallery" class="modal-gallery">
                <img id="modalMainImage" class="modal-main-image" src="" alt="Apartment">
                <button class="gallery-nav prev" onclick="prevImage()">‚Äπ</button>
                <button class="gallery-nav next" onclick="nextImage()">‚Ä∫</button>
                <div id="galleryCounter" class="gallery-counter"></div>
            </div>
            
            <div class="modal-details">
                <div class="modal-price" id="modalPrice"></div>
                <h2 class="modal-title" id="modalTitle"></h2>
                
                <div id="modalROI"></div>
                
                <div class="detail-grid" id="modalDetailsGrid"></div>
                
                <div class="modal-map" id="modalMap">üìç Map Location</div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const itemsPerPage = 20;
        let currentFilters = {};
        let currentApartment = null;
        let currentImageIndex = 0;
        let currentImages = [];

        async function loadFilterOptions() {
            try {
                const districtsResponse = await fetch('/api/marketplace/districts');
                if (districtsResponse.ok) {
                    const data = await districtsResponse.json();
                    populateDistrictFilter(data.districts);
                }
                
                const dispositionsResponse = await fetch('/api/marketplace/dispositions');
                if (dispositionsResponse.ok) {
                    const data = await dispositionsResponse.json();
                    populateDispositionFilter(data.dispositions);
                }
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        function populateDistrictFilter(districts) {
            const select = document.getElementById('filterDistrict');
            select.innerHTML = '<option value="">All Districts</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                select.appendChild(option);
            });
        }
        
        function populateDispositionFilter(dispositions) {
            const select = document.getElementById('filterDisposition');
            select.innerHTML = '<option value="">All Dispositions</option>';
            dispositions.forEach(disposition => {
                const option = document.createElement('option');
                option.value = disposition;
                option.textContent = disposition;
                select.appendChild(option);
            });
        }
        
        async function loadApartments() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('apartmentsList').style.display = 'none';
                
                const params = new URLSearchParams({
                    skip: currentPage * itemsPerPage,
                    limit: itemsPerPage,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/marketplace/?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const apartments = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                displayApartments(apartments);
                updatePagination(apartments.length);
                
            } catch (error) {
                console.error('Loading error:', error);
                document.getElementById('loading').innerHTML = 
                    `<span style="color: #ef4444;">Error: ${error.message}</span>`;
            }
        }
        
        function displayApartments(apartments) {
            const container = document.getElementById('apartmentsList');
            container.innerHTML = '';
            
            if (apartments.length === 0) {
                container.innerHTML = '<div class="col-12"><p style="color:#94a3b8; text-align:center; font-size:1.1rem;">No apartments found</p></div>';
                container.style.display = 'block';
                return;
            }
            
            apartments.forEach(apt => {
                const card = createApartmentCard(apt);
                container.appendChild(card);
            });
            
            container.style.display = 'flex';
        }
        
        function createApartmentCard(apt) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            
            let roiClass = 'roi-medium';
            if (apt.years_to_payback && apt.years_to_payback < 15) roiClass = 'roi-good';
            else if (apt.years_to_payback && apt.years_to_payback > 25) roiClass = 'roi-bad';
            
            col.innerHTML = `
                <div class="apartment-card">
                    <img src="${apt.main_image || 'https://via.placeholder.com/400x250?text=No+Image'}" 
                         class="apartment-image" 
                         alt="Apartment"
                         onerror="this.src='https://via.placeholder.com/400x250?text=No+Image'"
                         onclick="viewDetails(${apt.id})">
                    
                    <div class="apartment-details">
                        <h5>${apt.disposition || 'N/A'} ‚Ä¢ ${apt.surface || 'N/A'} m¬≤</h5>
                        
                        <p class="text-muted mb-2">
                            <small>üìç ${apt.district || 'Prague'}</small>
                            ${apt.distance_to_metro_km ? 
                                `<br><small>üöá ${apt.distance_to_metro_km.toFixed(1)} km to metro</small>` 
                                : ''}
                        </p>
                        
                        <div class="price-tag">${apt.price.toLocaleString()} CZK</div>
                        
                        ${apt.predicted_rent_price ? 
                            `<p class="mb-1"><small class="text-muted">Est. Rent: <strong>${Math.round(apt.predicted_rent_price).toLocaleString()} CZK/mo</strong></small></p>` 
                            : ''}
                        
                        ${apt.years_to_payback ? 
                            `<span class="roi-badge ${roiClass}">ROI: ${apt.years_to_payback} years</span>` 
                            : ''}
                        
                        <button class="btn btn-outline-primary mt-3 w-100" onclick="viewDetails(${apt.id})">
                            View Details
                        </button>
                    </div>
                </div>
            `;
            
            return col;
        }
        
        async function viewDetails(aptId) {
            try {
                const response = await fetch(`/api/marketplace/${aptId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                currentApartment = await response.json();
                currentImages = currentApartment.all_images || [];
                currentImageIndex = 0;
                
                displayModal(currentApartment);
                document.getElementById('apartmentModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('Error loading details:', error);
                alert('Error loading apartment details');
            }
        }
        
        function displayModal(apt) {
            document.getElementById('modalPrice').textContent = `${apt.price.toLocaleString()} CZK`;
            document.getElementById('modalTitle').textContent = 
                `${apt.disposition || 'N/A'} ‚Ä¢ ${apt.surface || 'N/A'} m¬≤ ‚Ä¢ ${apt.district || 'Prague'}`;
            
            let roiHTML = '';
            if (apt.years_to_payback) {
                let roiClass = 'roi-medium';
                if (apt.years_to_payback < 15) roiClass = 'roi-good';
                else if (apt.years_to_payback > 25) roiClass = 'roi-bad';
                roiHTML = `<span class="roi-badge ${roiClass}">ROI: ${apt.years_to_payback} years</span>`;
            }
            document.getElementById('modalROI').innerHTML = roiHTML;
            
            const detailsHTML = `
                ${createDetailItem('Sale Price', `${apt.price.toLocaleString()} CZK`)}
                ${createDetailItem('Est. Monthly Rent', apt.predicted_rent_price ? 
                    `${Math.round(apt.predicted_rent_price).toLocaleString()} CZK` : 'N/A')}
                ${createDetailItem('Surface Area', apt.surface ? `${apt.surface} m¬≤` : 'N/A')}
                ${createDetailItem('Layout', apt.disposition || 'N/A')}
                ${createDetailItem('District', apt.district || 'N/A')}
                ${createDetailItem('Furnishing', apt.furnishing || 'N/A')}
                ${createDetailItem('Nearest Metro', apt.nearest_metro || 'N/A')}
                ${createDetailItem('Distance to Metro', apt.distance_to_metro_km ? 
                    `${apt.distance_to_metro_km.toFixed(1)} km` : 'N/A')}
                ${createDetailItem('Distance to Center', apt.distance_to_center ? 
                    `${apt.distance_to_center.toFixed(1)} km` : 'N/A')}
            `;
            document.getElementById('modalDetailsGrid').innerHTML = detailsHTML;
            
            updateModalImage();
            
            if (apt.latitude && apt.longitude) {
                document.getElementById('modalMap').innerHTML = `
                    <iframe width="100%" height="320" frameborder="0" style="border:0; border-radius:10px;" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=${apt.longitude-0.01},${apt.latitude-0.01},${apt.longitude+0.01},${apt.latitude+0.01}&layer=mapnik&marker=${apt.latitude},${apt.longitude}"
                        allowfullscreen></iframe>
                `;
            } else {
                document.getElementById('modalMap').innerHTML = 'üìç Location not available';
            }
        }
        
        function createDetailItem(label, value) {
            return `
                <div class="detail-item">
                    <div class="detail-label">${label}</div>
                    <div class="detail-value">${value}</div>
                </div>
            `;
        }
        
        function updateModalImage() {
            if (currentImages.length > 0) {
                document.getElementById('modalMainImage').src = currentImages[currentImageIndex];
                document.getElementById('galleryCounter').textContent = 
                    `${currentImageIndex + 1} / ${currentImages.length}`;
                
                document.querySelector('.gallery-nav.prev').style.display = 
                    currentImageIndex === 0 ? 'none' : 'block';
                document.querySelector('.gallery-nav.next').style.display = 
                    currentImageIndex === currentImages.length - 1 ? 'none' : 'block';
            } else {
                document.getElementById('modalMainImage').src = 
                    'https://via.placeholder.com/1000x500?text=No+Images';
                document.getElementById('galleryCounter').textContent = '0 / 0';
                document.querySelector('.gallery-nav.prev').style.display = 'none';
                document.querySelector('.gallery-nav.next').style.display = 'none';
            }
        }
        
        function prevImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateModalImage();
            }
        }
        
        function nextImage() {
            if (currentImageIndex < currentImages.length - 1) {
                currentImageIndex++;
                updateModalImage();
            }
        }
        
        function closeModal() {
            document.getElementById('apartmentModal').classList.remove('active');
            document.body.style.overflow = '';
            currentApartment = null;
            currentImages = [];
            currentImageIndex = 0;
        }
        
        function closeModalOnOverlay(event) {
            if (event.target.id === 'apartmentModal') closeModal();
        }
        
        function applyFilters() {
            currentPage = 0;
            currentFilters = {};
            
            const district = document.getElementById('filterDistrict').value;
            const disposition = document.getElementById('filterDisposition').value;
            const minPrice = document.getElementById('filterMinPrice').value;
            const maxPrice = document.getElementById('filterMaxPrice').value;
            
            if (district) currentFilters.district = district;
            if (disposition) currentFilters.disposition = disposition;
            if (minPrice) currentFilters.min_price = minPrice;
            if (maxPrice) currentFilters.max_price = maxPrice;
            
            loadApartments();
        }
        
        function nextPage() {
            currentPage++;
            loadApartments();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadApartments();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function updatePagination(count) {
            document.getElementById('prevBtn').disabled = (currentPage === 0);
            document.getElementById('nextBtn').disabled = (count < itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1}`;
        }
        
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('apartmentModal');
            if (modal.classList.contains('active')) {
                if (e.key === 'Escape') closeModal();
                else if (e.key === 'ArrowLeft') prevImage();
                else if (e.key === 'ArrowRight') nextImage();
            }
        });
        
        loadFilterOptions().then(() => loadApartments());
    </script>
</body>
</html>