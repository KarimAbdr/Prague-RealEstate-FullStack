<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            padding: 40px 20px;
        }
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.2rem 0;
            margin-bottom: 40px;
        }
        .navbar-brand {
            font-size: 1.4rem;
            font-weight: 600;
            color: #f8fafc;
            text-align: center;
            display: block;
        }
        h1 {
            text-align: center;
            color: #f8fafc;
            margin-bottom: 50px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        h2 {
            text-align: center;
            color: #f8fafc;
            margin: 0 0 16px 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .stats {
            text-align: center;
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 20px;
        }
        .container {
            width: 95%;
            max-width: 1600px;
            margin: auto;
        }
        .chart-container {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
        }
        .error {
            text-align: center;
            color: #ef4444;
            padding: 20px;
            display: none;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }
        @media (max-width: 1024px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <span class="navbar-brand">Market Analytics Dashboard</span>
    </nav>

    <div class="container">
        <h1>Prague Real Estate Analytics</h1>
        
        <div class="charts-grid">
            <div class="chart-container">
                <h2>Distribution by Disposition</h2>
                <div id="loading1" class="loading">Loading...</div>
                <div id="error1" class="error"></div>
                <canvas id="dispositionChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Average Rent by Disposition</h2>
                <div id="loading2" class="loading">Loading...</div>
                <div id="error2" class="error"></div>
                <canvas id="averagePriceChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Rent Price Distribution</h2>
                <div id="stats3" class="stats"></div>
                <div id="loading3" class="loading">Loading...</div>
                <div id="error3" class="error"></div>
                <canvas id="rentDistChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Sale Price Distribution</h2>
                <div id="stats4" class="stats"></div>
                <div id="loading4" class="loading">Loading...</div>
                <div id="error4" class="error"></div>
                <canvas id="sellDistChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        async function fetchDispositionChart() {
            try {
                const response = await fetch('/api/analytics/count_by_disposition');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                document.getElementById('loading1').style.display = 'none';
                if (!data.labels || data.labels.length === 0) {
                    document.getElementById('error1').textContent = 'No data';
                    document.getElementById('error1').style.display = 'block';
                    return;
                }
                new Chart(document.getElementById('dispositionChart'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Listings',
                            data: data.values,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                document.getElementById('loading1').style.display = 'none';
                document.getElementById('error1').textContent = 'Error: ' + error.message;
                document.getElementById('error1').style.display = 'block';
            }
        }

        async function fetchAveragePriceChart() {
            try {
                const response = await fetch('/api/analytics/average_price');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                document.getElementById('loading2').style.display = 'none';
                if (!data.labels || data.labels.length === 0) {
                    document.getElementById('error2').textContent = 'No data';
                    document.getElementById('error2').style.display = 'block';
                    return;
                }
                new Chart(document.getElementById('averagePriceChart'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Avg Price (CZK)',
                            data: data.values,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: '#22c55e',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { callback: v => v.toLocaleString() + ' CZK' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                document.getElementById('loading2').style.display = 'none';
                document.getElementById('error2').textContent = 'Error: ' + error.message;
                document.getElementById('error2').style.display = 'block';
            }
        }

        async function fetchRentDistChart() {
            try {
                const response = await fetch('/api/analytics/price_distribution_rent');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                document.getElementById('loading3').style.display = 'none';
                if (!data.labels || data.labels.length === 0) {
                    document.getElementById('error3').textContent = 'No data';
                    document.getElementById('error3').style.display = 'block';
                    return;
                }
                document.getElementById('stats3').innerHTML = 
                    `Total: ${data.total} | Avg: ${data.avg.toLocaleString()} CZK | Range: ${data.min.toLocaleString()} - ${data.max.toLocaleString()} CZK`;
                new Chart(document.getElementById('rentDistChart'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Apartments',
                            data: data.values,
                            backgroundColor: 'rgba(168, 85, 247, 0.6)',
                            borderColor: '#a855f7',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                document.getElementById('loading3').style.display = 'none';
                document.getElementById('error3').textContent = 'Error: ' + error.message;
                document.getElementById('error3').style.display = 'block';
            }
        }

        async function fetchSellDistChart() {
            try {
                const response = await fetch('/api/analytics/price_distribution_sell');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                document.getElementById('loading4').style.display = 'none';
                if (!data.labels || data.labels.length === 0) {
                    document.getElementById('error4').textContent = 'No data';
                    document.getElementById('error4').style.display = 'block';
                    return;
                }
                document.getElementById('stats4').innerHTML = 
                    `Total: ${data.total} | Avg: ${(data.avg/1000000).toFixed(2)}M CZK | Range: ${(data.min/1000000).toFixed(1)}M - ${(data.max/1000000).toFixed(1)}M CZK`;
                new Chart(document.getElementById('sellDistChart'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Apartments',
                            data: data.values,
                            backgroundColor: 'rgba(234, 179, 8, 0.6)',
                            borderColor: '#eab308',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                document.getElementById('loading4').style.display = 'none';
                document.getElementById('error4').textContent = 'Error: ' + error.message;
                document.getElementById('error4').style.display = 'block';
            }
        }

        Promise.all([
            fetchDispositionChart(),
            fetchAveragePriceChart(),
            fetchRentDistChart(),
            fetchSellDistChart()
        ]);
    </script>
</body>
</html>